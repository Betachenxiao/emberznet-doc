# 在 ZigBee 设备上使用安装码 <!-- omit in toc -->

本应用笔记说明了如何使用 EM3xx 实用程序或 Simplicity Commander 来检查、写入、验证和擦除 Silicon Labs EM3x 和 EFR32 设备上的安装码。最后，还提供了一个完整的示例，说明如何使用安装码派生的链路密钥加入到 Z3 网络。

## 目录 <!-- omit in toc -->

- [1. 安装码概述](#1-安装码概述)
  - [1.1 安装码是什么](#11-安装码是什么)
  - [1.2 ZigBee 智慧能源设备的注意事项](#12-zigbee-智慧能源设备的注意事项)
- [2. 安全使用](#2-安全使用)

# 1. 安装码概述

## 1.1 安装码是什么

ZigBee 安装码（installation code）为设备提供了一种合适的安全入网方法。安装码本质上是在制造时安装在加入设备上的一个随机值，其用于加密集中式信任中心设备（协调器）到加入设备的初始网络密钥传输。随着 2016 年底 ZigBee 3.0 标准的创建，所有能够加入网络（非形成网络）的 ZigBee 设备在加入时都必须支持安装码的使用（这是 ZigBee 3.0 合规性的要求）。

当两个设备配对时，安装码与蓝牙设备上的 PIN 码类似。PIN 码作为父设备的授权码来提供，以便加入设备知道它正在安全地接收信息。

安装码通常以十六进制字符串或以一种编码方式（如条形码或 QR 码）印刷在设备的外壳或包装上，并与设备的 64-bit IEEE MAC 地址（“EUI64”）一起通过一个带外（out-of-band）机制提供给信任中心设备或其关联的 Web/Cloud 接口。如果这些特定数据存储在远程 Web 服务器或 cloud-based 系统上，则该远程系统随后应将该信息安全地传输到信任中心，以在加入设备执行带内（in-band）加入过程之前为加入设备建立安全凭证。

## 1.2 ZigBee 智慧能源设备的注意事项

信任中心和加入设备使用安装码作为共享密钥来建立初始信任关系，以允许新设备加入到 ZigBee 网络。一旦设备成功加入到被授权的网络，ZigBee 就要求该节点协商新的信任中心链路密钥，以便将来与信任中心进行安全交换。在标准的 ZigBee 3.0 网络中，该行为通过直接向信任中心发出密钥请求来实现。然而，ZigBee 智慧能源网络与标准 ZigBee 3.0 网络不同，新的信任中心链路密钥是通过一个称为 CBKE（Certificate-Based Key Establishment）的特殊过程派生出的。有关 CBKE 过程的详情，请参阅 **UG103.5: Fundamentals of ZigBee Security**。

> 注意：CBKE 过程需要在制造过程中安装 Certicom 签署的 CBKE 数据证书。有关如何设置这些证书数据的详情，请参阅 **AN708: Setting Smart Energy Certificates for ZigBee Devices**。另请参阅 **AN714: Smart Energy ECC-Enabled Device Setup Process**，以了解更多关于 ZigBee 智慧能源设备加入到网络的要求，以及该过程的故障排除。

本文档概述了与标准 Z3 设备或 ZSE 设备的安装码相关的常见实践。

# 2. 安全使用

安装码用于创建预配置链路密钥。通过在安装码上使用 AES-MMO 哈希算法，可以将安装码转换为链路密钥。有关更多信息和示例代码，请参阅 **ZigBee Alliance’s Base Device Behavior Specification (ZigBee document #13-0402)** 的安全章节的安装码部分。

安装码虽然不完全是一个秘密，但是其不容易被监听（加入设备与信任中心之间的）初始交换的恶意设备推测出来。在不知道安装码和密钥的情况下，恶意设备无法解密消息。

派生的 ZigBee 链路密钥只有信任中心和加入设备知道。信任中心使用该密钥将 ZigBee 网络密钥安全地传输到设备。一旦设备拥有网络密钥，它就可以在网络层上与 ZigBee 网络通信。设备就能够执行服务发现并开始应用的初始化过程。在 Z3（non-ZSE）网络中，拥有网络密钥通常足以跨各种簇（cluster）进行标准消息传递。但是，ZSE 网络还有其他限制，如下所述。请参阅 [7. 示例：使用安装码派生的链路密钥将 Z3 Light 加入到 Z3 网关]()，以便按步骤执行使用安装码生成的链路密钥进行网络加入的过程。

从安装码派生的初始链路密钥在 ZSE 网络上没有完整访问权限。尝试将其用于智慧能源消息传递是不被允许的，并且其他 ZSE 设备将忽略它。在加入网络（不久）后，设备必须使用 `Key Establishment cluster` 来通过 CBKE 过程与信任中心建立新的链路密钥。只有在密钥建立成功完成时，设备才会在网络上拥有完整的权限，并且能够发送和接收某些 ZSE 消息。
