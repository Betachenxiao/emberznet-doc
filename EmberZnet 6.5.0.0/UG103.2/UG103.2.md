# ZigBee 基础 (Rev. 1.1) <!-- omit in toc -->

本文描述了 ZigBee 解决方案的关键特性和特征，并且还包括了一个关于 ZigBee 3.0 的部分。

## 目录 <!-- omit in toc -->

- [1. 引言](#1-引言)
  - [1.1 一般特征](#11-一般特征)
  - [1.2 IEEE 802.15.4](#12-ieee-802154)
  - [1.3 硬件和软件元素](#13-硬件和软件元素)
    - [1.3.1 关于应用框架](#131-关于应用框架)
    - [1.3.2 其他工具和实用程序](#132-其他工具和实用程序)
- [2. Zigbee Mesh 网络](#2-zigbee-mesh-网络)
  - [2.1 星形网络](#21-星形网络)
  - [2.2 全 Mesh 网络](#22-全-mesh-网络)
  - [2.3 混合 Mesh 网络](#23-混合-mesh-网络)
- [3. 网络节点类型](#3-网络节点类型)
  - [3.1 协调器](#31-协调器)
  - [3.2 路由器](#32-路由器)
  - [3.3 终端设备](#33-终端设备)

# 1. 引言

ZigBee 指的是：

* 一个可靠、经济、低功耗、无线设备间通信的开放标准。
* 一个由 400 多家公司组成的联盟，他们共同定义并使用该标准来在各种应用（如智慧能源和商业楼宇自动化）中进行通信。

ZigBee Alliance 由一帮组成董事会的发起人（promoter）成员公司领导。Silicon Labs 是董事会成员之一。ZigBee 还拥有大量参与者（participant）和采用者（adopter）成员，他们在技术和营销工作组内工作，以创建和维护标准。联盟的活动是通过专门针对该技术特定领域的工作组（包括网络组、安全组、应用配置文件组和其他几个组）完成的。所有的 ZigBee 文档都可以在 ZigBee 网站 [www.zigbee.org](www.zigbee.org) 上找到。最新的规范文档只有 ZigBee Alliance 成员才能访问。要在产品中使用 ZigBee 技术，公司必须成为联盟的成员。

Silicon Labs 活跃于联盟的各个领域，并通过其 Ember® ZigBee 解决方案帮助客户采用 ZigBee 技术。Ember ZigBee 平台是迄今为止所有新标准的测试和认证的参考平台。Ember 公司于 2012 年 7 月被 Silicon Labs 收购，它是 ZigBee Alliance 的创始成员。

ZigBee Alliance 指定了三个主要项。

1. ZigBee 网络 - 网络交互的基本标准（包括可接受的 RF 行为、创建和加入网络的方法、发现路由以及使用路由来通过网络传输流量）。ZigBee Alliance 提供了其他网络规范（如 RF4CE 和 GreenPower），但本文档着重于 ZigBee PRO。
2. ZigBee 应用层 - 描述 ZigBee 应用的一组消息和网络设置。遵守这些设置的所有设备都可以互操作。在 ZigBee 3.0 之前，每个应用配置文件（无论是公共的还是私有的）都有自己的认证程序。ZigBee 3.0 是一个通用的应用层认证程序，适用于所有 ZigBee 产品。下图展示了一些（最初的）单独的 ZigBee 应用配置文件。

    <div align=center title="Figure 1.1. ZigBee Application Profiles"><img src="./Figure/Figure1.1.png" alt="Figure 1.1. ZigBee Application Profiles"/></div>

3. 认证 - ZigBee 应用由联盟认证以向最终用户表明设备是合规的。使用私有配置文件（profile）的应用可以通过认证来表明它正确地使用了 ZigBee 协议栈，并且在运行期间不会对其他 ZigBee 网络产生不良影响。详情请参阅 [7. ZigBee 合规性]()。

由于 ZigBee 致力于开放和可互操作的设备，因此它们存在或开发的地方（从物理层到应用层）都采用了标准，如下图所示。在物理层和 MAC（媒体访问控制）层，ZigBee 采用了 IEEE 802.15.4 标准。网络、安全和应用层都是由 ZigBee Alliance 开发的。ZigBee Alliance 还开发了一个由网关（gateway）和 commissioning 工具等支持系统组成的生态系统，以简化 ZigBee 网络的开发和部署。标准的扩展和附件还在继续开发中，Silicon Labs 致力于支持这些标准。

<div align=center title="Figure 1.2. ZigBee Architecture"><img src="./Figure/Figure1.2.png" alt="Figure 1.2. ZigBee Architecture"/></div>

后面三个小节描述了 ZigBee 网络的一般特征，讨论了 IEEE 802.15.4 标准的使用，并总结了 ZigBee 网络的硬件和软件元素。

## 1.1 一般特征

ZigBee 旨在成为一种经济高效的低功耗解决方案。它面向多个市场，包括家庭自动化、楼宇自动化、传感器网络、智慧能源和个人健康护理监测。ZigBee 网络的一般特征如下：

* 低功耗 - 设备通常可以使用合适的工作周期在 AA 型电池上运行数年。通过极其谨慎的设计和特殊的电池技术，一些 ZigBee 设备（如燃气表）可以达到 20 年的电池寿命。
* 低数据速率 - 在 2.4GHz 频段下支持 250kbps 的无线数据速率（网络中的实际持续流量速率低于该理论值）。因此，ZigBee 更适用于采样和监控应用或基本控制应用。请参阅 **AN1138: ZigBee Mesh Network Performance** 和 **AN1142: Mesh Network Performance Comparison**。
* 小型和大型网络 - ZigBee 网络规模可以从几个设备到数千个设备。网络层使用多种不同的数据传输机制（路由类型）来设计，以根据预期用途优化网络操作。
* 范围 - 一般设备提供足够的范围来覆盖普通家庭。可以使用功率放大器来大幅度地扩展了范围。在物理层上使用分布式扩频，以更好地抵抗干扰。
* 简单的网络安装、启动和操作 - ZigBee 标准支持多种网络拓扑。用于形成和加入网络的简单协议允许系统在发生路由问题时自行配置和修复。

## 1.2 IEEE 802.15.4

ZigBee 网络基于 IEEE 802.15.4 的 MAC 层和物理层。802.15.4 标准在 2.4GHz 频段下以 250kbps 运行，在 900/868MHz 频段下以 40/20kbps 运行。许多芯片公司提供 2.4GHz 频段下的解决方案，其中少数支持 900/868MHz 频段。ZigBee PRO 使用 802.15.4-2003。

802.15.4 的 MAC 层用于基本消息处理和拥塞控制。该 MAC 层包括形成和加入网络的机制、用于为设备监听空闲信道的 CSMA 机制，以及用于相邻设备间可靠通信的重试处理和消息确认的链路层。ZigBee 网络层建立在这些底层机制之上，以在网络中提供可靠的端到端通信。802.15.4 标准可从 [www.ieee.org](www.ieee.org) 中下载。

802.15.4 标准在 MAC 层中提供了 ZigBee 在任何当前协议栈配置文件中都未使用的一些选项。这种未使用的特性的一个例子是保证时隙（GTS，guaranteed time slots），其将被网络用于跨设备同步无线电活动。因此，这些项通常不包含在 ZigBee 软件栈中以节省代码空间。ZigBee 还对 ZigBee 规范附录 D 中记录的 802.15.4 MAC 进行了具体更改。

## 1.3 硬件和软件元素

ZigBee 解决方案需要实现 ZigBee 无线电和相关的微处理器（在单个芯片中或单独），并在 ZigBee 协议栈之上实现应用。EmberZNet PRO 是 Silicon Labs 的 ZigBee PRO 协议栈实现。

一般地，开发者可以购买 ZigBee 无线电和软件作为捆绑包。通常，硬件和软件供应商提供包括用于软件的示例应用和硬件的参考设计。基于这些，硬件开发者可以根据自己的特定需求定制硬件。或者，许多模块提供商可以提供紧凑且低成本的定制模块。

由于 ZigBee 应用的嵌入特性，软件应用开发通常与硬件设计相互关联，以提供最佳解决方案。Silicon Labs 提供基于 ZigBee 规范的标准网络 API 和应用框架，其为客户提供一种基于 ZigBee 应用配置文件和 ZigBee 簇库（ZCL）的快速开发应用方法，如下所述。另外，许多第三方软件开发公司专门开发 ZigBee 应用，并可以协助新产品开发。

### 1.3.1 关于应用框架

任何应用都可以从零构建，但这是一个缓慢且冗长的过程。另一种方法是获取工作代码并对其进行修改以满足应用的要求。适应工作设计是构建应用的一种更简单、更有效的方法，尤其是使用新技术的第一个应用。为了解决这个问题，Silicon Labs 不仅提供示例应用代码，还提供一个或多个应用框架作为其开发平台的一部分。应用框架包含存储在库和插件中的 Silicon Labs 提供的代码体，Silicon Labs 还提供 Simplicity Studio，其中包括基于 AppBuilder 的 IDE。AppBuilder 是一个交互式 GUI 工具，允许您配置应用框架中包含的库和插件，以在应用配置文件中实现设备。

应用框架目前有两种样式或版本（version 2 and version 6）。该版本决定已安装的目录结构、可用的元数据以及某些功能是硬编码还是通过插件可用。这两个版本之间的差异在 **UG102: Application Framework User Guide** 中详细描述。EmberZNet PRO 协议栈包括这两个版本的应用框架。ZigBee PRO 应用框架（也称为 ZCL Application Framework V2），是一个 version 2 框架，通常称为 AFV2。网络协处理器应用框架也随 EmberZNet PRO 协议栈一起提供，其使用 version 6 开发。

AFV2 基于 ZCL，用于开发 ZigBee PRO 应用。它提供了一组嵌入式代码，用于实现 ZCL-based cluster 处理、所需的网络任务和一般的 ZigBee 应用状态机，并包含对 ZigBee 3.0 应用层的支持，以及许多传统的 ZigBee 配置文件（例如 Home Automation（HA），Smart Energy（SE）和 ZigBee Light Link（ZLL））。此代码是根据 Silicon Labs 推荐的最佳实践和不同 ZigBee 应用配置文件的规范开发的，可作为一种 “软件参考设计”，可在片上系统（如 EFR32）上运行或者在主机处理器上连接到基于 EZSP（EmberZNet 串行协议）的网络控制处理器。

Silicon Labs 正致力于将这两个版本协调为一个框架版本。与此同时，无论它们是在 v2 还是 v6 下开发的，应用框架都提供了通用的基本服务，并且当与设备特定的代码结合使用时，可为您提供设备的大部分的无线行为。然后，您的任务就是开发特定于硬件的功能，并将其与 Silicon Labs 软件连接起来。每个 Silicon Labs 协议栈版本都提供了一些基于相关应用框架的常见用例示例。

使用应用框架有以下好处：

* 帮助维护一个通用方法，并遵守协议标准和 Silicon Labs 最佳实践。
* 帮助确保协议合规性，因为 Silicon Labs 通过预合规性测试运行应用框架。
* 允许简易地合并更新，因为 Silicon Labs 维护核心组件。
* 提供在应用中包含复杂任务的能力，而无需在代码级管理这些任务。
* 提供可配置性，同时维护协议合规性以及简易地更新到未来协议栈版本的能力。
* 提供一个回调/命令接口和一组配置点，这些配置点通常更远离协议栈，因此与栈级行为相比更符合应用层行为。
* 提供一组插件来说明更高级应用逻辑的 “最佳实践” 实现，例如调试功能和 CLI 功能、ZCL 簇实现、应用状态机或复杂功能。

所有这些都有助于加快产品上市速度和更强大的解决方案。

### 1.3.2 其他工具和实用程序

除了 Simplicity Studio 和 AppBuilder，Silicon Labs 还提供了许多在开发过程中可供开发人员使用的实用程序和工具，包括：

* Over-the-air（OTA）bootloaders，允许在部署后升级系统软件
* 网关接口，以将 ZigBee 网络连接到其他系统
* 微处理器的编程工具
* 网络嗅探器和调试工具，允许查看和分析网络操作
* 与领先公司合作的处理器调试工具

# 2. Zigbee Mesh 网络

嵌入式 Mesh 网络允许无线电中继其他无线电的消息，从而使无线电系统更加可靠。例如，如果节点不能直接向另一节点发送消息，则嵌入式 Mesh 网络会通过一个或多个中间节点来中继消息。

EmberZNet PRO 支持 Mesh 网络拓扑的三种类型，如下图所示：

* 星形网络（Star Network）
* 全 Mesh 网络（Full Mesh Network）
* 混合 Mesh 网络（Hybrid Mesh Network）

<div align=center title="Figure 2.1. Star, Full Mesh, and Hybrid Mesh Networks"><img src="./Figure/Figure2.1.png" alt="Figure 2.1. Star, Full Mesh, and Hybrid Mesh Networks"/></div>

> 注意：上图中的蓝色设备为终端设备，其可能处于睡眠或移动状态。有关终端设备的更多信息，请参见 [3. 网络节点类型](#3-网络节点类型)。

## 2.1 星形网络

在星形网络中，一个集线器（hub）是所有通信的中心点。集线器可能会成为网络/处理带宽的瓶颈。这种拓扑结构不太像 Mesh，并且传输受到集线器的通信半径限制。外围节点可以通过电池供电。在 EmberZNet PRO 协议栈中，此拓扑由一组终端设备和一个协调器节点组成；协调器作为父节点，并节点充当网络集线器。

## 2.2 全 Mesh 网络

在全 Mesh 网络中，所有节点都是路由器节点（包括形成网络后的协调器节点）。由于所有节点都可以为所有其他节点中继信息，因此该拓扑最不容易受到链路故障的影响（不容易出现单点故障现象）。

## 2.3 混合 Mesh 网络

混合 Mesh 网络拓扑结合了星形和全 Mesh 策略。其存在几个星型网络，但它们的集线器可以作为 Mesh 网络进行通信。混合网络容许了比星形拓扑更长的通信距离和比 Mesh 拓扑更多的分层设计能力。此拓扑由 EmberZNet PRO 协议栈形成，其使用路由器设备作为星型子网络的集线器，路由器可以被终端设备附着连接。

选择拓扑时必须考虑哪些节点是线路供电还是电池供电、预期的电池寿命、所需的网络流量、延迟要求、解决方案成本以及其他因素。详情请参见 **UG103.3: Software Design Fundamentals**。

# 3. 网络节点类型

Zigbee 规范指定单个网络中最多支持一个协调器、多个路由器和多个终端设备。后面的小节将介绍这些节点类型。

## 3.1 协调器

协调器（ZC，Zigbee coordinator）负责形成一个集中式网络（centralized network）。协调器是具有一些额外功能的路由器，其使用一个硬编码网络地址（`0x0000`）。Zigbee 协调器的功能包括在扫描到可用信道后选择合适的信道和选择 Extended PAN ID（参见 [5.4 Extended PAN ID]()）。在形成网络之后，协调器充当路由器。

协调器还增加了一些职责，例如充当信任中心（trust center）或网络管理器（network manager）。信任中心管理网络的安全设置和授权。网络管理器监视和纠正网络问题，例如 PAN ID 冲突或由于干扰导致的信道变化。这些选择取决于应用开发者，并在某些情况下由使用的应用层（如 Zigbee 3.0）完成。

> 注意：在启动网络时，出于安全目的，只能将协调器指定为集中式信任中心。

## 3.2 路由器

路由器（ZR，Zigbee router）为网络设备提供路由服务。路由器也可以作为终端设备。与终端设备不同是，路由器不是专门为睡眠设备设计的，并且只要网络已建立它就应该保持开启状态。

## 3.3 终端设备

终端设备（ZED，Zigbee end devices）是叶节点（即子节点），其只能通过其父节点进行通信。与路由器设备不同是，终端设备不能中继其他节点的消息。

根据网络协议栈，终端设备可以有以下几种类型：

* 嗜睡终端设备（`EmberNodeType EMBER_SLEEPY_END_DEVICE`）。它们会在空闲时关闭自身的无线电，从而节省资源。但是，它们必须轮询它们的父节点以接收传入的消息和确认。父节点在嗜睡终端设备请求数据之前，不会向其发送数据。嗜睡终端设备有时也被称为 rx-off-when-idle 设备。这是标准的 Zigbee 设备类型。
* 非嗜睡终端设备（`EmberNodeType EMBER_END_DEVICE`）。虽然它们不会为其他设备路由消息，但是它们在运行期间保持供电。这些设备称为 rx-on-when-idle 设备。这是标准的 Zigbee 设备类型。

EmberZNet PRO 协议栈支持上述的两种终端设备。节点类型的选择必须经过仔细考虑。例如，在一个非常密集的网络中，所有线路供电的节点都为路由器不是总是有利的，因为当子节点试图找到与之通信的父节点时可能会发生干扰的问题。考虑的要点是应该尝试创建一个平衡的网络，其中所有节点都具有冗余的路径，但没有过多的路由器在附近制造干扰。
