# ZigBee 基础 (Rev. 1.1) <!-- omit in toc -->

本文描述了 ZigBee 解决方案的关键特性和特征，并且还包括了一个关于 ZigBee 3.0 的部分。

## 目录 <!-- omit in toc -->

- [1. 引言](#1-引言)
  - [1.1 一般特征](#11-一般特征)
  - [1.2 IEEE 802.15.4](#12-ieee-802154)
  - [1.3 硬件和软件元素](#13-硬件和软件元素)
    - [1.3.1 关于应用框架](#131-关于应用框架)
    - [1.3.2 其他工具和实用程序](#132-其他工具和实用程序)
- [2. ZigBee Mesh 网络](#2-zigbee-mesh-网络)
  - [2.1 星形网络](#21-星形网络)
  - [2.2 全 Mesh 网络](#22-全-mesh-网络)
  - [2.3 混合 Mesh 网络](#23-混合-mesh-网络)
- [3. 网络节点类型](#3-网络节点类型)
  - [3.1 协调器](#31-协调器)
  - [3.2 路由器](#32-路由器)
  - [3.3 终端设备](#33-终端设备)
- [4. ZigBee 路由概念](#4-zigbee-路由概念)
  - [4.1 概述](#41-概述)
    - [4.1.1 表路由](#411-表路由)
    - [4.1.2 广播路由](#412-广播路由)
    - [4.1.3 多播路由](#413-多播路由)
    - [4.1.4 多对一/源路由](#414-多对一源路由)
  - [4.2 使用链路质量来援助路由](#42-使用链路质量来援助路由)
    - [4.2.1 相关邻居表字段的描述](#421-相关邻居表字段的描述)
    - [4.2.2 链路状态消息](#422-链路状态消息)
    - [4.2.3 网络层如何使用双向开销](#423-网络层如何使用双向开销)
    - [4.2.4 关键概念：快速响应](#424-关键概念快速响应)
    - [4.2.5 关键概念：连接管理](#425-关键概念连接管理)
  - [4.3 路由发现与修复](#43-路由发现与修复)
    - [4.3.1 路由发现](#431-路由发现)
    - [4.3.2 路由修复](#432-路由修复)
  - [4.4 重试与确认](#44-重试与确认)
    - [4.4.1 MAC Retries and ACKs (802.15.4)](#441-mac-retries-and-acks-802154)
    - [4.4.2 NWK Retries](#442-nwk-retries)
    - [4.4.3 APS Retries and ACKs](#443-aps-retries-and-acks)
    - [4.4.4 总结](#444-总结)

# 1. 引言

ZigBee 指的是：

* 一个可靠、经济、低功耗、无线设备间通信的开放标准。
* 一个由 400 多家公司组成的联盟，他们共同定义并使用该标准来在各种应用（如智慧能源和商业楼宇自动化）中进行通信。

ZigBee Alliance 由一帮组成董事会的发起人（promoter）成员公司领导。Silicon Labs 是董事会成员之一。ZigBee 还拥有大量参与者（participant）和采用者（adopter）成员，他们在技术和营销工作组内工作，以创建和维护标准。联盟的活动是通过专门针对该技术特定领域的工作组（包括网络组、安全组、应用配置文件组和其他几个组）完成的。所有的 ZigBee 文档都可以在 ZigBee 网站 [www.zigbee.org](www.zigbee.org) 上找到。最新的规范文档只有 ZigBee Alliance 成员才能访问。要在产品中使用 ZigBee 技术，公司必须成为联盟的成员。

Silicon Labs 活跃于联盟的各个领域，并通过其 Ember® ZigBee 解决方案帮助客户采用 ZigBee 技术。Ember ZigBee 平台是迄今为止所有新标准的测试和认证的参考平台。Ember 公司于 2012 年 7 月被 Silicon Labs 收购，它是 ZigBee Alliance 的创始成员。

ZigBee Alliance 指定了三个主要项。

1. ZigBee 网络 - 网络交互的基本标准（包括可接受的 RF 行为、创建和加入网络的方法、发现路由以及使用路由来通过网络传输流量）。ZigBee Alliance 提供了其他网络规范（如 RF4CE 和 GreenPower），但本文档着重于 ZigBee PRO。
2. ZigBee 应用层 - 描述 ZigBee 应用的一组消息和网络设置。遵守这些设置的所有设备都可以互操作。在 ZigBee 3.0 之前，每个应用配置文件（无论是公共的还是私有的）都有自己的认证程序。ZigBee 3.0 是一个通用的应用层认证程序，适用于所有 ZigBee 产品。下图展示了一些（最初的）单独的 ZigBee 应用配置文件。

    <div align=center title="Figure 1.1. ZigBee Application Profiles"><img src="./Figure/Figure1.1.png" alt="Figure 1.1. ZigBee Application Profiles"/></div>

3. 认证 - ZigBee 应用由联盟认证以向最终用户表明设备是合规的。使用私有配置文件（profile）的应用可以通过认证来表明它正确地使用了 ZigBee 协议栈，并且在运行期间不会对其他 ZigBee 网络产生不良影响。详情请参阅 [7. ZigBee 合规性]()。

由于 ZigBee 致力于开放和可互操作的设备，因此它们存在或开发的地方（从物理层到应用层）都采用了标准，如下图所示。在物理层和 MAC（媒体访问控制）层，ZigBee 采用了 IEEE 802.15.4 标准。网络、安全和应用层都是由 ZigBee Alliance 开发的。ZigBee Alliance 还开发了一个由网关（gateway）和 commissioning 工具等支持系统组成的生态系统，以简化 ZigBee 网络的开发和部署。标准的扩展和附件还在继续开发中，Silicon Labs 致力于支持这些标准。

<div align=center title="Figure 1.2. ZigBee Architecture"><img src="./Figure/Figure1.2.png" alt="Figure 1.2. ZigBee Architecture"/></div>

后面三个小节描述了 ZigBee 网络的一般特征，讨论了 IEEE 802.15.4 标准的使用，并总结了 ZigBee 网络的硬件和软件元素。

## 1.1 一般特征

ZigBee 旨在成为一种经济高效的低功耗解决方案。它面向多个市场，包括家庭自动化、楼宇自动化、传感器网络、智慧能源和个人健康护理监测。ZigBee 网络的一般特征如下：

* 低功耗 - 设备通常可以使用合适的工作周期在 AA 型电池上运行数年。通过极其谨慎的设计和特殊的电池技术，一些 ZigBee 设备（如燃气表）可以达到 20 年的电池寿命。
* 低数据速率 - 在 2.4GHz 频段下支持 250kbps 的无线数据速率（网络中的实际持续流量速率低于该理论值）。因此，ZigBee 更适用于采样和监控应用或基本控制应用。请参阅 **AN1138: ZigBee Mesh Network Performance** 和 **AN1142: Mesh Network Performance Comparison**。
* 小型和大型网络 - ZigBee 网络规模可以从几个设备到数千个设备。网络层使用多种不同的数据传输机制（路由类型）来设计，以根据预期用途优化网络操作。
* 范围 - 一般设备提供足够的范围来覆盖普通家庭。可以使用功率放大器来大幅度地扩展了范围。在物理层上使用分布式扩频，以更好地抵抗干扰。
* 简单的网络安装、启动和操作 - ZigBee 标准支持多种网络拓扑。用于形成和加入网络的简单协议允许系统在发生路由问题时自行配置和修复。

## 1.2 IEEE 802.15.4

ZigBee 网络基于 IEEE 802.15.4 的 MAC 层和物理层。802.15.4 标准在 2.4GHz 频段下以 250kbps 运行，在 900/868MHz 频段下以 40/20kbps 运行。许多芯片公司提供 2.4GHz 频段下的解决方案，其中少数支持 900/868MHz 频段。ZigBee PRO 使用 802.15.4-2003。

802.15.4 的 MAC 层用于基本消息处理和拥塞控制。该 MAC 层包括形成和加入网络的机制、用于为设备监听空闲信道的 CSMA 机制，以及用于相邻设备间可靠通信的重试处理和消息确认的链路层。ZigBee 网络层建立在这些底层机制之上，以在网络中提供可靠的端到端通信。802.15.4 标准可从 [www.ieee.org](www.ieee.org) 中下载。

802.15.4 标准在 MAC 层中提供了 ZigBee 在任何当前协议栈配置文件中都未使用的一些选项。这种未使用的特性的一个例子是保证时隙（GTS，guaranteed time slots），其将被网络用于跨设备同步无线电活动。因此，这些项通常不包含在 ZigBee 软件栈中以节省代码空间。ZigBee 还对 ZigBee 规范附录 D 中记录的 802.15.4 MAC 进行了具体更改。

## 1.3 硬件和软件元素

ZigBee 解决方案需要实现 ZigBee 无线电和相关的微处理器（在单个芯片中或单独），并在 ZigBee 协议栈之上实现应用。EmberZNet PRO 是 Silicon Labs 的 ZigBee PRO 协议栈实现。

一般地，开发者可以购买 ZigBee 无线电和软件作为捆绑包。通常，硬件和软件供应商提供包括用于软件的示例应用和硬件的参考设计。基于这些，硬件开发者可以根据自己的特定需求定制硬件。或者，许多模块提供商可以提供紧凑且低成本的定制模块。

由于 ZigBee 应用的嵌入特性，软件应用开发通常与硬件设计相互关联，以提供最佳解决方案。Silicon Labs 提供基于 ZigBee 规范的标准网络 API 和应用框架，其为客户提供一种基于 ZigBee 应用配置文件和 ZigBee 簇库（ZCL）的快速开发应用方法，如下所述。另外，许多第三方软件开发公司专门开发 ZigBee 应用，并可以协助新产品开发。

### 1.3.1 关于应用框架

任何应用都可以从零构建，但这是一个缓慢且冗长的过程。另一种方法是获取工作代码并对其进行修改以满足应用的要求。适应工作设计是构建应用的一种更简单、更有效的方法，尤其是使用新技术的第一个应用。为了解决这个问题，Silicon Labs 不仅提供示例应用代码，还提供一个或多个应用框架作为其开发平台的一部分。应用框架包含存储在库和插件中的 Silicon Labs 提供的代码体，Silicon Labs 还提供 Simplicity Studio，其中包括基于 AppBuilder 的 IDE。AppBuilder 是一个交互式 GUI 工具，允许您配置应用框架中包含的库和插件，以在应用配置文件中实现设备。

应用框架目前有两种样式或版本（version 2 and version 6）。该版本决定已安装的目录结构、可用的元数据以及某些功能是硬编码还是通过插件可用。这两个版本之间的差异在 **UG102: Application Framework User Guide** 中详细描述。EmberZNet PRO 协议栈包括这两个版本的应用框架。ZigBee PRO 应用框架（也称为 ZCL Application Framework V2），是一个 version 2 框架，通常称为 AFV2。网络协处理器应用框架也随 EmberZNet PRO 协议栈一起提供，其使用 version 6 开发。

AFV2 基于 ZCL，用于开发 ZigBee PRO 应用。它提供了一组嵌入式代码，用于实现 ZCL-based cluster 处理、所需的网络任务和一般的 ZigBee 应用状态机，并包含对 ZigBee 3.0 应用层的支持，以及许多传统的 ZigBee 配置文件（例如 Home Automation（HA），Smart Energy（SE）和 ZigBee Light Link（ZLL））。此代码是根据 Silicon Labs 推荐的最佳实践和不同 ZigBee 应用配置文件的规范开发的，可作为一种 “软件参考设计”，可在片上系统（如 EFR32）上运行或者在主机处理器上连接到基于 EZSP（EmberZNet 串行协议）的网络控制处理器。

Silicon Labs 正致力于将这两个版本协调为一个框架版本。与此同时，无论它们是在 v2 还是 v6 下开发的，应用框架都提供了通用的基本服务，并且当与设备特定的代码结合使用时，可为您提供设备的大部分的无线行为。然后，您的任务就是开发特定于硬件的功能，并将其与 Silicon Labs 软件连接起来。每个 Silicon Labs 协议栈版本都提供了一些基于相关应用框架的常见用例示例。

使用应用框架有以下好处：

* 帮助维护一个通用方法，并遵守协议标准和 Silicon Labs 最佳实践。
* 帮助确保协议合规性，因为 Silicon Labs 通过预合规性测试运行应用框架。
* 允许简易地合并更新，因为 Silicon Labs 维护核心组件。
* 提供在应用中包含复杂任务的能力，而无需在代码级管理这些任务。
* 提供可配置性，同时维护协议合规性以及简易地更新到未来协议栈版本的能力。
* 提供一个回调/命令接口和一组配置点，这些配置点通常更远离协议栈，因此与栈级行为相比更符合应用层行为。
* 提供一组插件来说明更高级应用逻辑的 “最佳实践” 实现，例如调试功能和 CLI 功能、ZCL 簇实现、应用状态机或复杂功能。

所有这些都有助于加快产品上市速度和更强大的解决方案。

### 1.3.2 其他工具和实用程序

除了 Simplicity Studio 和 AppBuilder，Silicon Labs 还提供了许多在开发过程中可供开发人员使用的实用程序和工具，包括：

* Over-the-air（OTA）bootloaders，允许在部署后升级系统软件
* 网关接口，以将 ZigBee 网络连接到其他系统
* 微处理器的编程工具
* 网络嗅探器和调试工具，允许查看和分析网络操作
* 与领先公司合作的处理器调试工具

# 2. ZigBee Mesh 网络

嵌入式 Mesh 网络允许无线电中继其他无线电的消息，从而使无线电系统更加可靠。例如，如果节点不能直接向另一节点发送消息，则嵌入式 Mesh 网络会通过一个或多个中间节点来中继消息。

EmberZNet PRO 支持 Mesh 网络拓扑的三种类型，如下图所示：

* 星形网络（Star Network）
* 全 Mesh 网络（Full Mesh Network）
* 混合 Mesh 网络（Hybrid Mesh Network）

<div align=center title="Figure 2.1. Star, Full Mesh, and Hybrid Mesh Networks"><img src="./Figure/Figure2.1.png" alt="Figure 2.1. Star, Full Mesh, and Hybrid Mesh Networks"/></div>

> 注意：上图中的蓝色设备为终端设备，其可能处于睡眠或移动状态。有关终端设备的更多信息，请参见 [3. 网络节点类型](#3-网络节点类型)。

## 2.1 星形网络

在星形网络中，一个集线器（hub）是所有通信的中心点。集线器可能会成为网络/处理带宽的瓶颈。这种拓扑结构不太像 Mesh，并且传输受到集线器的通信半径限制。外围节点可以通过电池供电。在 EmberZNet PRO 协议栈中，此拓扑由一组终端设备和一个协调器节点组成；协调器作为父节点，并节点充当网络集线器。

## 2.2 全 Mesh 网络

在全 Mesh 网络中，所有节点都是路由器节点（包括形成网络后的协调器节点）。由于所有节点都可以为所有其他节点中继信息，因此该拓扑最不容易受到链路故障的影响（不容易出现单点故障现象）。

## 2.3 混合 Mesh 网络

混合 Mesh 网络拓扑结合了星形和全 Mesh 策略。其存在几个星型网络，但它们的集线器可以作为 Mesh 网络进行通信。混合网络容许了比星形拓扑更长的通信距离和比 Mesh 拓扑更多的分层设计能力。此拓扑由 EmberZNet PRO 协议栈形成，其使用路由器设备作为星型子网络的集线器，路由器可以被终端设备附着连接。

选择拓扑时必须考虑哪些节点是线路供电还是电池供电、预期的电池寿命、所需的网络流量、延迟要求、解决方案成本以及其他因素。详情请参见 **UG103.3: Software Design Fundamentals**。

# 3. 网络节点类型

ZigBee 规范指定单个网络中最多支持一个协调器、多个路由器和多个终端设备。后面的小节将介绍这些节点类型。

## 3.1 协调器

协调器（ZC，ZigBee coordinator）负责形成一个集中式网络（centralized network）。协调器是具有一些额外功能的路由器，其使用一个硬编码网络地址（`0x0000`）。ZigBee 协调器的功能包括在扫描到可用信道后选择合适的信道和选择 Extended PAN ID（参见 [5.4 Extended PAN ID]()）。在形成网络之后，协调器充当路由器。

协调器还增加了一些职责，例如充当信任中心（trust center）或网络管理器（network manager）。信任中心管理网络的安全设置和授权。网络管理器监视和纠正网络问题，例如 PAN ID 冲突或由于干扰导致的信道变化。这些选择取决于应用开发者，并在某些情况下由使用的应用层（如 ZigBee 3.0）完成。

> 注意：在启动网络时，出于安全目的，只能将协调器指定为集中式信任中心。

## 3.2 路由器

路由器（ZR，ZigBee router）为网络设备提供路由服务。路由器也可以作为终端设备。与终端设备不同是，路由器不是专门为睡眠设备设计的，并且只要网络已建立它就应该保持开启状态。

## 3.3 终端设备

终端设备（ZED，ZigBee end devices）是叶节点（即子节点），其只能通过其父节点进行通信。与路由器设备不同是，终端设备不能中继其他节点的消息。

根据网络协议栈，终端设备可以有以下几种类型：

* 嗜睡终端设备（`EmberNodeType EMBER_SLEEPY_END_DEVICE`）。它们会在空闲时关闭自身的无线电，从而节省资源。但是，它们必须轮询它们的父节点以接收传入的消息和确认。父节点在嗜睡终端设备请求数据之前，不会向其发送数据。嗜睡终端设备有时也被称为 rx-off-when-idle 设备。这是标准的 ZigBee 设备类型。
* 非嗜睡终端设备（`EmberNodeType EMBER_END_DEVICE`）。虽然它们不会为其他设备路由消息，但是它们在运行期间保持供电。这些设备称为 rx-on-when-idle 设备。这是标准的 ZigBee 设备类型。

EmberZNet PRO 协议栈支持上述的两种终端设备。节点类型的选择必须经过仔细考虑。例如，在一个非常密集的网络中，所有线路供电的节点都为路由器不是总是有利的，因为当子节点试图找到与之通信的父节点时可能会发生干扰的问题。考虑的要点是应该尝试创建一个平衡的网络，其中所有节点都具有冗余的路径，但没有过多的路由器在附近制造干扰。

# 4. ZigBee 路由概念

## 4.1 概述

ZigBee 有多种路由机制，可以根据网络和预期流量模型来使用。在 **ZigBee Specification (document 05-3474, section 3.4, section 3.6.3)** 中描述了命令帧的帧格式和路由行为。

应用设计者应选择将哪种机制用作系统架构和设计的一部分。在实际实践中，一个应用可以使用若干个路由机制，因为一些设备可以执行一对一通信，而一些设备可以与中央监控设备通信。下面将讨论的路由类型为：

* 表路由（Table Routing）
* 广播路由（Broadcast Routing）
* 多播路由（Multicast Routing）
* 多对一/源路由（Many-to-One/Source Routing）

### 4.1.1 表路由

当一个节点发送路由请求以发现到另一个节点的路径时，将形成路由。在两个节点之间的路由被发现后，源节点将其消息发送到路由中的第一个节点（在路由表中指定）。每个中间节点使用自身的路由表将消息转发到路由的下一个节点（即 “跳”），直到消息到达目的地。如果路由失败，则将路由错误发送回消息的发起方，然后发起方可以重新发现该路由。

### 4.1.2 广播路由

广播路由是一种向网络中所有设备发送消息的机制。网络级广播选项仅用于发送到路由器和所有非嗜睡节点（包括终端设备），或者也发送到嗜睡终端设备。广播消息会被网络中所有具有路由器能力的设备重复三次，以确保消息被传递到所有设备。虽然广播是一种发送消息的可靠方式，但由于其对网络性能有影响，所以应谨慎使用广播。重复广播会限制网络中可能发生的任何其他流量。广播不是传递给嗜睡设备的可靠方式，因为父设备负责缓冲嗜睡子设备的消息，而该消息可能在终端设备唤醒接收之前被丢弃。

### 4.1.3 多播路由

多播路由提供一对多路由选项。当一个设备想要向一组设备发送消息时使用多播（例如一个灯开关向一组灯发送一个开启命令）。在此机制下，所有设备都应加入一个多播分组。只有那些属于该分组的成员设备才会收到消息，但其他设备会路由这些多播消息。多播是带过滤的限制性广播。它应仅在应用必要时使用，因为过度使用广播机制会降低网络性能。多播消息是永远不会被确认的。

### 4.1.4 多对一/源路由

多对一路由是用来允许整个网络具有一条到中央控制或监视设备的路径的一种简单的机制。在正常的表路由下，中央设备及其附近的设备将需要路由表空间来存储网络中每个设备的下一跳和中央设备自身的入口。鉴于 ZigBee 网络中经常使用存储器受限设备，这些大型表是不必要的。

在多对一路由下，称为 “集中器（concentrator）” 的中央设备发送单个路由发现，该发现在所有路由器中建立单个路由表条目以向中央设备提供下一跳。这产生了一个类似于表路由的结果，但其具有单个多对一路由请求，而不是从每个路由器向集中器的多个单独的一对一路由请求。

然后，网络中的所有设备都具有到集中器的下一跳路径，并且只使用了单个表条目。然而，中央设备通常还需要将消息发送回网络。这将导致路由表大小的显著增加，特别是对于最靠近集中器的那些节点，因为它们是集中器到网络其余部分的多个出站路由中的中继点。相反，到集中器的传入消息首先使用路由记录消息来存储沿路由使用的跳跃序列。然后，集中器以相反的顺序将这些下一跳路由存储为称作 “源路由表” 的本地保留表中的 “源路由”。传出消息在消息的网络报头中包括此源路由。然后使用网络报头中的下一跳而不是路由表来路由消息。这提供了大型可扩展网络，而不会增加所有设备的内存要求。应该注意的是，如果要存储这些源路由，则集中器需要一些额外的内存。

有关消息传递的详细信息，请参阅 [www.zigbee.org](www.zigbee.org) 上提供的 ZigBee 规范。

## 4.2 使用链路质量来援助路由

本节中的信息是为那些希望了解网络层操作细节的人提供的，这可以在故障排除过程中证明是有用的。另外，链路状态消息由协议栈自动处理，应用的编写者无需关心它。

由于本地底噪、接收器灵敏度和发射功率的变化，无线网络中的链路通常具有不对称的链路质量。路由层必须使用双向链路质量的知识来建立工作路由并优化这些路由的可靠性和效率。它还可以使用这些知识来通过单个发现建立可靠的双向路由。

ZigBee 路由器保持对邻居表中的入站链路质量进行跟踪，一般地以物理层作出的平均 LQI（Link Quality Indicator，链路质量指标）测量值作为参考。为了处理链路不对称，ZigBee PRO 协议栈配置文件指定路由器获取并存储由其邻居测量的传出链路开销。这是通过周期性单跳广播交换链路状态信息来实现的，称为 “链路状态” 消息。下面解释链路状态算法（如 EmberZNet PRO 中所实现）。

### 4.2.1 相关邻居表字段的描述

ZigBee 路由器在邻居表中存储有关相邻 ZigBee 设备的信息。对于每个路由器邻居，该条目包括以下字段：

* 平均传入 LQI（average incoming LQI）
* 传出开销（outgoing cost）
* 年龄（age）

传入 LQI 字段是来自邻居的所有传入数据的 LQI 的指数加权移动平均值。使用查找表（lookup table）来从该值计算出邻居的传入开销。

传出开销是邻居在其邻居交换消息中报告的传入开销。传出开销为 0 意味着开销未知。如果一个条目具有非零传出开销，则称为 “双向”，否则称为 “单向”。

年龄字段测量自收到最后一个邻居交换消息以来的时间量。新条目从 0 岁开始。每个 `EM_NEIGHBOR_AGING_PERIOD` 会增加年龄，当前为 16 秒。接收邻居交换数据包会将年龄重置为 `EM_MIN_NEIGHBOR_AGE`，前提是该年龄已经至少为 `EM_MIN_NEIGHBOR_AGE`（当前定义为 3）。这使得可以识别最近添加到表中的节点并避免驱逐它们，从而减少了密集网络中的系统颠簸。如果年龄大于 `EM_STALE_NEIGHBOR`（当前为 6），则该条目将被视为陈旧的，并且传出开销将重置为 0。

### 4.2.2 链路状态消息

路由器每 16 秒（加上或减去 2 秒的抖动）发送一个链路状态消息。如果路由器没有双向链路，则发送速度提高到八倍。数据包作为不带重试的单跳广播发送。在 EmberZNet PRO 协议栈中，它们作为 ZigBee 网络命令帧发送。

有效载荷包含所有非陈旧邻居的短 ID 列表，以及它们的传入和传出开销。传入开销始终为 1 到 7 之间的值。传出开销为 0 到 7 之间的值，值 0 表示未知的传出开销。有关帧格式的详细信息，请参阅 **ZigBee specification**。链路状态消息由 Simplicity Studio 网络分析仪自动解码，以便于参考。

在接收到链路状态消息时，要么该邻居已经存在一个邻居条目，要么如果有空间或邻居选择策略决定用它替换旧条目则会添加一个邻居条目。如果条目没有进入表中，则简单地丢弃数据包。如果条目进入到表中，则传出开销字段将与发送方的邻居交换消息中列出的接收节点的传入开销一起更新。如果消息中未列出接收方，则将传出开销字段设置为 0。年龄字段设置为 `EM_MIN_NEIGHBOR_AGE`。

### 4.2.3 网络层如何使用双向开销

如上所述，路由算法利用双向开销信息来避免创建断掉的路由，并优化已建立路由的效率和稳健性。对于熟悉 ZigBee 路由发现过程的读者，本小节详细介绍了如何使用传出开销。该机制非常简单，但提供了上述所有优点。

在接收到路由请求命令帧时，将在邻居表中搜索发送设备的对应条目。如果没有找到这样的条目，或者条目的传出开销字段的值为 0，则丢弃该帧并终止路由请求处理。

如果找到具有非零传出开销的条目，则传入和传出开销的最大值用于路径开销计算，而不是仅用于传入开销。该值还用于在重发之前增加路由请求帧的路径开销字段。

### 4.2.4 关键概念：快速响应

快速响应允许已启动或重置的节点快速获取与其邻居的双向链路，从而最大限度地缩短应用必须等待协议栈准备好参与路由的时间。此特性是 100% ZigBee 兼容的。

如果收到的链路状态消息不包含双向链路，并且接收方已将发送方添加到其邻居表中，则接收方立即发送其自己的链路状态消息，以便快速启动发送方。该消息仍然通过 2 秒抖动，以避免与其他快速响应方发生冲突。为了避免连锁反应，快速响应方必须自己至少有一个双向链路。

### 4.2.5 关键概念：连接管理

本质上 ZigBee 设备受 RAM 限制，但 ZigBee 网络通常是密集的。这意味着每个路由器都在大量的其他路由器的无线电范围内。在这种情况下，邻居的数量可以超过设备邻居表中的最大条目数。这时，错误地选择保留哪些邻居会导致路由效率低下或更糟糕（网络断开）。EmberZNet PRO 协议栈采用 100% ZigBee 兼容的算法来管理密集网络中邻居的选择，以优化网络连接。

## 4.3 路由发现与修复

ZigBee 中的路由由网络层自动处理，应用开发者通常不需要关心其行为。然而在需要发现或修复路由时，了解网络的行为是非常有用的。

### 4.3.1 路由发现

当单播消息从一个设备发送到另一个设备并且没有预先存在的路由时将启动路由发现。

我们假设没有现存的路由，因此网络软件将开始路由发现过程。为简单起见，假设所有设备的路由表都是空白的。

例如，假设设备 A 需要向设备 C 发送消息，如下图所示。设备 A 将向整个网络广播一个消息，以请求设备 C 进行应答。该广播消息还用于建立返回 A 的临时路由，因为每个中间设备将记录发送消息给它的设备。路由将在中间节点上更新（注意，这些是临时条目，其生命周期比常规条目短，并且不打算重复使用）。因为 A 是单跳邻居，所以 B 和 D 不需要存储关于它的路由信息。

<div align=center title="Figure 4.1. Example Network"><img src="./Figure/Figure4.1.png" alt="Figure 4.1. Example Network"/></div>

C 可以使用 B 或 D 作为其下一跳。ZigBee 将此选择留给实现；Silicon Labs 使用加权算法来选择最明显可靠的下一跳。

当消息到达设备 C 时，C 使用步骤 1 中建立的临时路由将特殊的单播消息（称为路由响应消息）发回给 A，如下图所示。中间设备使用此消息建立一个（常驻）路由返回到 C。

<div align=center title="Figure 4.2. Unicast Message (Green) with Acknowledgement (Blue)"><img src="./Figure/Figure4.2.png" alt="Figure 4.2. Unicast Message (Green) with Acknowledgement (Blue)"/></div>

由于 C 是单跳邻居，因此 B 不需要存储有关它的路由信息。D 不参与发现过程的这一部分，因为在上述步骤中 A 没有选择它。当消息到达设备 A 时，路由发现完成，新路由可用于从 A 到 C 发送数据消息。

ZigBee PRO 网络将检测非对称 RF 链路并在路由发现期间避开它们。这提高了发现过程和结果路由的可靠性。

在特定超时期限内（EmberZNet 3.0 及更高版本中为 1 分钟）未使用的路由将被标记为重用（re-use），然后新路由可能会覆盖该内存位置。在某些情况下，可能需要一个新路由，并且一个或多个中间设备将不具有可用的路由表条目；在这种情况下，消息将被报告为 “无法传递” 到发送节点。

应用指定接收方是否应发送端到端确认（这称为 APS 确认）。如果是，则在等待确认超时的情况下，发送方将在成功传递后收到通知。在超时的情况下，可能需要修复路由。

### 4.3.2 路由修复

当发送带有请求确认的单播消息时，将在消息成功传递时通知发送设备。如果没有收到此确认，则可以采取措施来修复路由。路由修复遵循与上述路由发现完全相同的步骤，但是受损节点（下图中的 B）不参与，这将导致路由选择的不同。

<div align=center title="Figure 4.3. Network with a Damaged Node"><img src="./Figure/Figure4.3.png" alt="Figure 4.3. Network with a Damaged Node"/></div>

更新 A 的路由表以反映下一跳是 D，并且消息沿新路径成功传递，如下图所示。

<div align=center title="Figure 4.4. Alternative Route"><img src="./Figure/Figure4.4.png" alt="Figure 4.4. Alternative Route"/></div>

如果没有可用的替代路径，则发送方会被告知消息无法传递。在 EmberZNet PRO 中，使用 `EmberStatus` 的 `EMBER_DELIVERY_FAILED (0x66)` 来响应指示。

在执行路由修复之前，EmberZNet PRO 将尝试再次发送消息。在消息选项中设置 `EMBER_APS_OPTION_RETRY` 和 `EMBER_APS_OPTION_ENABLE_ROUTE_DISCOVERY` 时，将自动执行路由修复。

## 4.4 重试与确认

ZigBee 及其底层提供了一个重试和确认的系统，旨在有效地管理 RF 通信的不确定性。开始使用 ZigBee 时，没有必要理解这个概念，但在特定情况下，某些应用开发者可能会对此感兴趣。

本节逐层讨论重试与确认（Retrie and Acknowledgement）：

* MAC retries and ACKs (802.15.4)
* NWK retries (ZigBee NWK layer)
* APS retries and ACKs (ZigBee APS layer)

### 4.4.1 MAC Retries and ACKs (802.15.4)

下图说明了 MAC 层传输重试过程。

<div align=center title="Figure 4.5. MAC Retry and ACK Process"><img src="./Figure/Figure4.5.png" alt="Figure 4.5. MAC Retry and ACK Process"/></div>

MAC 层将尝试传输五次。

* 如果信道非空闲（CCA fail）或未从下一跳目的地接收到 MAC 级 ACK，则将发生单播重试。
* 在 CCA 失败的情况下将发生广播重试，但是广播不使用 MAC ACK 能力。

这些重试发送得非常快 - 完全失败的最大重试时间约为 37ms。注意，MAC ACK 会立即从发送方发回，没有额外的 CCA - 有关详细信息，请参阅 802.15.4 文档。

### 4.4.2 NWK Retries

ZigBee 中的 NWK 重试是特定于供应商的。下图说明了 EmberZNet PRO 协议栈的 NWK 层传输重试过程。

<div align=center title="Figure 4.6. NWK Retry Process"><img src="./Figure/Figure4.6.png" alt="Figure 4.6. NWK Retry Process"/></div>

仅当 MAC 层指示传输失败时才会发生 NWK 重试。NWK 重试比 MAC 重试的操作时间更长，因此在存在中期（1-500ms）干扰时，NWK 重试为网络提供了额外的鲁棒性。

Silicon Labs 的干扰研究表明，在某些情况下，NWK 层重试对于克服来自 WiFi 的临时干扰非常重要。

* 单播：单播行为如流程图所述，重试时间最长为 500ms。
* 广播：广播消息每 500ms 重发一次，共计 3 次（包含初始广播），或者直到听到所有邻居自己重新广播消息（从而确保完整传输）。

### 4.4.3 APS Retries and ACKs

下图说明了 APS 层重试过程。

<div align=center title="Figure 4.7. APS Layer Retry Process"><img src="./Figure/Figure4.7.png" alt="Figure 4.7. APS Layer Retry Process"/></div>

APS 层有一个 ACK 标志，该标志控制是否使用额外的逻辑来等待确认，并且如果未听到确认则进行重试。这表示一个来自接收方设备的完整的端到端确认。

可以进一步选择性地配置 APS 层，以便在 APS 发送失败时修复到目的地的路由。

对于广播消息，没有等效的 APS 端到端确认。

### 4.4.4 总结

如果可以向目的地发送消息，则自动的 ZigBee 行为将提供 “最大努力”，通过尝试在几个不同的时间尺度（从 1 毫秒到几秒）上使用可选的端到端 ACK 和路由修复进行重试。

如果传递失败，建议应用在重试之前等待更长的时间（这会给时间以清除干扰或故障）。在极端带宽拥塞的情况下，应用重试实际上可能会助长问题。
