# 安全基础 (Rev. 1.0) <!-- omit in toc -->

本文档介绍了一些基本的安全概念，包括网络层安全、信任中心和应用支持层安全特性。然后讨论了 EmberZNet PRO 中可用的标准安全协议的类型。总结了对实施安全性的编码要求。最后，提供了有关实施 ZigBee 智慧能源安全的信息。

## 目录 <!-- omit in toc -->

- [1. 引言](#1-引言)
- [2. 概念](#2-概念)
  - [2.1 网络层安全](#21-网络层安全)
    - [2.1.1 网络密钥](#211-网络密钥)
    - [2.1.2 逐跳安全](#212-逐跳安全)
    - [2.1.3 包安全](#213-包安全)
    - [2.1.4 辅助报头](#214-辅助报头)
    - [2.1.5 认证和加密](#215-认证和加密)
    - [2.1.6 网络安全帧计数器](#216-网络安全帧计数器)
    - [2.1.7 未加密的网络数据](#217-未加密的网络数据)
  - [2.2 信任中心网络](#22-信任中心网络)
  - [2.3 分布式信任中心网络](#23-分布式信任中心网络)
  - [2.4 APS 层安全](#24-aps-层安全)
    - [2.4.1 端到端安全](#241-端到端安全)
    - [2.4.2 链路密钥](#242-链路密钥)
    - [2.4.3 未加密的 APS 数据](#243-未加密的-aps-数据)

# 1. 引言

安全性是 ZigBee 架构中的一个主要关注点。虽然 ZigBee 使用 IEEE 802.15.4 中的基本安全元素（如 AES（Advanced Encryption Standard，高级加密标准）加密和带 CBC-MAC（CCM）安全模式的计数器），并在此之上进行扩展：

* 128 位 AES 加密算法
* Strong, U.S. National Institute of Standards and Technology (NIST)-approved security
* 定义密钥类型（链路，网络）
* 定义密钥设置和维护
* 密钥可以硬连线到应用中
* CCM\*（统一/简单的操作模式）
* 信任中心（Trust center）
* 可以为应用自定义安全性

如下图所示，安全服务提供者（security services provider）限制与应用层和网络层的交互。

ZigBee 现在支持一种单一定义的安全模式，称为标准安全（Standard Security）。该模式中存在各种策略来控制设备在网络上的行为或交互方式。早期版本的 ZigBee 标准采用的是称为住宅安全（Residential Security）和高级安全（High Security）的模式。这些都已被弃用。

> 注意：ZigBee 不使用 IEEE 802.15.4 MAC 级安全，因此 EmberZNet PRO 不支持这种安全，此处不再赘述。ZigBee 在网络层和应用层实现消息安全。

<div align=center title="Figure 1.1. ZigBee Stack Architecture"><img src="./Figure/Figure1.1.png" alt="Figure 1.1. ZigBee Stack Architecture"/></div>

本文档首先介绍了一些基本的安全概念，包括网络层安全、信任中心和应用支持层安全特性。然后讨论了 EmberZNet PRO 中可用的标准安全协议的类型。总结了对实施安全性的编码要求。最后，提供了有关实施 ZigBee 智慧能源安全的信息。详情可以在文档 **AN714, Smart Energy ECC-Enabled Device Setup** 中找到。

已经熟悉 ZigBee 安全概念的开发者可以跳到 [4. ZigBee 智慧能源安全]()。

# 2. 概念

## 2.1 网络层安全

本节介绍 ZigBee 如何在网络层实现安全性，这适用于标准安全。网络安全提供了独立于可能在 ZigBee 节点上运行的应用的安全性。所有经过 ZigBee 认证的设备都必须使用网络层安全。它提供了基本的访问控制，这用于控制允许哪些节点参与特定的 ZigBee 网络。有关应用控制安全，请参阅 [2.4 APS 层安全]()。

### 2.1.1 网络密钥

网络安全使用网络范围密钥（network-wide key）进行加密和解密。所有被授权加入网络的设备都有该密钥的副本，并且这些设备使用该密钥来加密和解密所有网络消息。网络密钥还具有与之关联的序列号，以标识密钥的特定实例。当更新网络密钥时，序列号会被递增，以允许设备识别使用了哪个网络密钥实例来保护包数据。序列号的范围从 0 到 255。当序列号达到 255 时，它将绕回到 0。

> 注意：所有 ZigBee 密钥的长度均为 128 位。

所有属于安全 ZigBee 网络的设备都具有网络密钥的副本。

### 2.1.2 逐跳安全

需要注意的是，ZigBee 中的网络安全是在逐跳（hop-by-hop）基础上进行的。每个转发已加密包的路由器在执行进一步处理之前都会先验证该包是否是有效的已加密包。路由器通过执行 ZigBee 解密机制和验证包完整性来对包进行认证。然后，在将消息发送到下一跳之前，它会使用自己的网络参数（如源地址和帧计数器）重新加密包。如果没有此保护，攻击者可以将消息重播到网络中，该消息将通过多个设备进行路由，从而消耗网络资源。使用逐跳安全允许路由器阻止将错误流量注入网络的尝试。

### 2.1.3 包安全

网络层保护的包由下图所示的元素组成。

<div align=center title="Figure 2.1. Anatomy of a Packet Secured at the Network Layer"><img src="./Figure/Figure2.1.png" alt="Figure 2.1. Anatomy of a Packet Secured at the Network Layer"/></div>

### 2.1.4 辅助报头

辅助报头（auxiliary header）包含关于包安全的数据，接收节点使用该数据来正确地认证和解密包。该数据包括所使用的密钥类型、序列号（如果是网络密钥）、保护数据的设备的 IEEE 地址及帧计数器。

### 2.1.5 认证和加密

ZigBee 使用 128 位对称密钥（AES-128）加密网络层上的所有传输。网络报头和辅助报头以明文（但已认证）的方式发送，而网络有效载荷则经过认证和加密。AES-128 用于创建消息（报头和有效载荷）的整个网络部分的散列，该散列附加到消息的末尾。此散列称为 MIC（Message Integrity Code，消息完整码），它可以确保消息未被修改。接收设备对消息进行散列处理，并根据附加到消息的值验证计算出的 MIC。对消息的更改将使 MIC 无效，接收节点将完全丢弃该消息。

> 注意：ZigBee 使用一个 4 字节的 MIC。

### 2.1.6 网络安全帧计数器

辅助报头中包含帧计数器来作为防止重播攻击的手段。所有设备都有自己的传出帧计数器，并且它们维护邻居和子系的帧计数器的列表。设备每次发送包时，都会递增其传出帧计数器。接收设备验证发送设备的帧计数器是否已从其看到的最后一个值增加。如果没有增加，数据包将被静默丢弃。如果接收设备不是最终目的地，则对包进行解密和修改以包含路由设备的帧计数器。然后重新加密数据包并将其发送到下一跳。

帧计数器为 32 位并且可能不会回零。可以在帧计数器达到其最大值之前更新网络密钥。当发生这种情况时，如果本地设备的值大于 0x80000000，则帧计数器可以重置为零。

### 2.1.7 未加密的网络数据

所有正常的网络数据报都需要具有网络安全和有效的帧计数器。唯一的例外是在加入期间，当设备还没有网络密钥时。在这种情况下，加入设备的消息将通过其父设备进行转发，直到它完全加入和认证。在没有网络层安全的情况下收到的任何其他消息都将被静默丢弃。

## 2.2 信任中心网络

可以通过称为信任中心的中央集权来控制安全网络中的认证。所有进入网络的设备将暂时地加入网络，直到联系到信任中心（决定是否允许新设备进入网络）。新加入设备的父节点充当信任中心和加入设备之间的中继。只有认证消息才能发送到设备或从设备发出，直到完全加入和认证为止。

信任中心可以选择在设备加入时执行以下三种操作之一：

* 发送当前网络密钥的副本，该副本从父节点中继到正在加入的设备。
* 向父节点发送命令以将设备从网络中移除，从而不准许其加入。
* 忽略请求。如果设备在 2 秒内没有收到网络密钥，则父节点将静默地将设备从网络中移除。

一旦节点具有网络密钥，它就被认为是完全加入和认证的，并且可以与网络上的任何设备通信。

使用信任中心进行操作的网络总是需要信任中心来认证任何新设备。两个设备之间的正常消息不需要信任中心参与。

## 2.3 分布式信任中心网络

网络可以在没有集中认证的情况下形成。这种网络称为分布式信任中心网络。在这种情况下，任何路由器都可以授权和认证希望加入的新设备。

这些网络提供了一种更简单的机制，可以将设备添加到网络中，其代价是网络的安全性较低。

在网络形成时应决定使用分布式信任中心网络还是信任中心网络，因为网络启动后无法更改此决定。

## 2.4 APS 层安全

本节介绍 ZigBee 如何在应用支持（APS，Application Support）层实现安全性。

### 2.4.1 端到端安全

APS 安全旨在提供一种在 ZigBee 网络内安全地发送消息的方法，使得除了源和目的地之外，没有其他设备可以解密数据。这与网络安全不同，后者仅提供逐跳安全。在这种情况下，每个设备都是网络的一部分，将听到包被中继到其目的地并被解密。

APS 安全使用只有源和目标知道的共享密钥（shared key），从而提供端到端安全。

APS 层和网络层加密可以同时用于加密消息的内容。在这种情况下，首先实施 APS 层安全，然后是网络层安全。

APS 层保护的包由下图所示的元素组成。

<div align=center title="Figure 2.2. APS Packet Security"><img src="./Figure/Figure2.2.png" alt="Figure 2.2. APS Packet Security"/></div>

### 2.4.2 链路密钥

APS 安全使用称为链路密钥（link key）的点对点（peer-to-peer）密钥。在发送 APS 保护的数据之前，两个设备必须已相互建立了此密钥。链路密钥有两种类型：信任中心链路密钥（trust center link key）和应用链路密钥（application link key）。

#### 信任中心链路密钥 <!-- omit in toc -->

信任中心链路密钥是一种特殊链路密钥（其中一个伙伴设备是信任中心）。协议栈使用此密钥向信任中心发送和从信任中心接收 APS 命令消息。应用还可以使用此密钥发送 APS 加密的数据消息。

ZigBee 网络中的所有设备都必须具有链路密钥。在信任中心网络中，设备必须具有信任中心链路密钥。在分布式信任中心网络中，此密钥称为分布式信任中心链路密钥（Distributed Trust Center link key）。

#### 应用链路密钥 <!-- omit in toc -->

应用链路密钥是可以在网络中的任意两个节点之间建立的共享密钥（其中两个设备都不是信任中心）。该密钥可用于为发送到或从运行在节点上的应用发送的消息添加额外的安全性。设备可以为与之通信的每个设备使用不同的应用链路密钥。

设备可以预先配置应用链路密钥，也可以在自身和其他设备之间请求链路密钥。在后一种情况下，设备将向信任中心发出请求（使用其信任中心链路密钥加密）。信任中心充当两个设备的可信第三方，因此它们可以安全地建立彼此之间的通信。这将在 [3.2.4 应用链路密钥]() 中进一步讨论。建立应用链路密钥的过程如下图所示。

<div align=center title="Figure 2.3. Establishing an Application Key"><img src="./Figure/Figure2.3.png" alt="Figure 2.3. Establishing an Application Key"/></div>

### 2.4.3 未加密的 APS 数据

APS 层安全独立于网络层安全。对于 ZigBee 协议栈发送到信任中心和从信任中心发出的某些安全消息（APS 命令），它是必需的。

与网络安全不同，应用消息的 APS 安全是可选的。应用消息不会在 APS 层自动加密，即使没有 APS 加密，接收端也不会忽略它。各个应用可以选择是接受还是拒绝没有 APS 层安全的消息。例如，智慧能源配置文件描述了 ZigBee 簇消息需要具备哪些安全。
