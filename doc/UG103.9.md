# **UG103.9：EMBER® APPLICATION DEVELOPMENT FUNDAMENTALS: ZLL** <!-- omit in toc -->

本文将 ZLL 栈和网络与 EmberZNet PRO 栈和网络进行了比较，并提供了有关实施 ZLL 解决方案时的注意事项的说明。包括 ZLL 配置和试运行的基本描述，关于 ZLL 和 Non-ZLL 设备的互操作性的说明。

## **本版本的新增内容** <!-- omit in toc -->

初始发行。

------------------------------------------------------------------------------------------------------------------------

- [**1. 引言**](#1-引言)
- [**2. ZLL 网络试运行过程**](#2-zll-网络试运行过程)
    - [**2.1 设备发现**](#21-设备发现)
    - [**2.2 标识**](#22-标识)
    - [**2.3 形成和加入场景**](#23-形成和加入场景)
- [**3. ZLL 和 Non-ZLL 设备**](#3-zll-和-non-zll-设备)
    - [**3.1 簇**](#31-簇)
    - [**3.2 设备 ID**](#32-设备-id)

------------------------------------------------------------------------------------------------------------------------

# **1. 引言**

ZigBee Light Link（ZLL）配置文件是基于 ZigBee PRO 的 ZigBee 应用程序配置文件，旨在用于（over-the-counter）消费类照明应用。根据规范，ZLL 配置文件的声明目的如下：
* 为照明设备提供进化的消费者体验，在这些设备中进一步的购买可以增强整个系统。
* 为消费市场领域的（over-the-counte）灯和灯具开发一个简单明了的 ZigBee 规范。
* 开发一套解决方案，充分符合消费者市场边界条件，包括试运行、安全性、易用性、网络规模，成本等。
* 能够解决在 ZigBee 家庭自动化（ZHA）配置文件中未解决的消费者（非安装者）照明相关特性。

ZLL 旨在与其他 ZigBee 配置文件（如家庭自动化）进行本地互操作，但最初并不打算用于高级住宅、商业建筑、工业或专业户外照明网络。

------------------------------------------------------------------------------------------------------------------------

# **2. ZLL 网络试运行过程**

ZLL 网络试运行（commissioning）通过一个称为触摸链接（touchlinking）的过程进行。触摸链接有两个初始阶段，设备发现（device discovery）和标识（identifying），随后是一些依赖于所涉及设备状态的场景。触摸链接涉及两方，一个是 “发起者（initiator）”，这是一个启动发现过程的设备（通常是某种控制器）；一个 “目标（target）”，即被发现的设备（通常是一个灯）。自从离开网络或形成新网络以来未参与任何触摸链接的设备被称为 “新出厂（factory new）”，并且其在某些情况下的行为与非新出厂的行为不同。在适用的情况下，这些差异如下所述。触摸链接允许一种方法，以发现并将两个紧邻的设备连接到同一 ZLL PAN 中。

## **2.1 设备发现**

只有 “具有地址分配能力” 的设备，即那些能够维护（为其他设备分配的）已使用和可用网络地址列表的设备，才能启动设备发现。在发起者端，设备发现以八个 inter-PAN 扫描请求命令帧的广播开始，其中 ZLL 信息字段的触摸链接发起者子字段被设置为 1 并且带一个为 0 dBm 的标称输出功率。传输过程如下：
* 发起者切换到第一个主要 ZLL 信道（即信道 11），并广播五个连续的扫描请求 inter-PAN 命令帧。
* 然后，发起者切换到剩余的三个主要 ZLL 信道，并在每个信道上广播单个扫描请求命令帧。
* 在每次传输之后，发起者等待固定的时间以接收任何响应。
* 如果需要进行扩展扫描（即，为了重置为新出厂或如果发起者是 Non-ZLL 网络的一部分），则发起者切换到每个次要 ZLL 信道，并在每个信道上广播单个扫描请求命令帧和等待接收任何响应。

如果接收到具有有效事务标识符的任何响应，则发起者可以通过单播一个设备信息请求 inter-PAN 命令帧来请求目标的子设备信息；然而，如果目标只有一个子设备，则这是不必要的。如果接收到具有有效事务标识符的任何响应并且扫描响应 inter-PAN 命令帧的 ZLL 信息字段的触摸链接优先级请求位被设置为 1，则发起者可以考虑对这些设备进行优先处理。

设备发现操作可以随时中止。如果在扫描期间，非新出厂发起者从新出厂目标接收到另一个扫描请求 inter-PAN 命令帧，则忽略该请求。

在目标端，如果目标是终端设备，则它可能首先需要被唤醒，以使其能够启用其接收器并响应来自发起者的扫描。这是通过应用程序特定的方法来完成的。如果新出厂目标启动扫描，则它将根据来自非新出厂发起者的扫描请求 inter-PAN 命令帧进行响应。接收扫描请求命令帧的设备可以选择是否响应；如果是，则设备将单播一个扫描响应 inter-PAN 命令帧到接收扫描请求命令帧的同一信道上的发起者。如果发起者成功接收到响应帧，则目标将忽略来自具有相同事务标识符的同一发起者的连续扫描请求帧。

预期目标只有在其 RSSI 值超过某个制造商的特定阈值且 ZLL 信息字段的链接发起者子字段设置为 1 时，才会响应扫描请求帧。然后以为 0 dBm 的标称输出功率传输扫描响应帧。目标将扫描响应帧的 RSSI 校正字段设置为某些产品特定的 RSSI 校正值，以补偿无线电和产品外侧之间的 RF 信号损失；然后，发起者可以使用每个所发现目标中的此值来选择适当的设备。如果目标设备希望在触摸链接期间被发起者视为优先级，则将 ZLL 信息字段的触摸链接优先级请求位设置为 1。目标将响应标识符字段设置为随机（非顺序）值。如果不是新出厂的，则目标将扩展 PAN 标识符、网络更新标识符、逻辑信道，PAN 标识符和网络地址字段设置为路由器在其启动阶段期间从 NVM 确定的相应值。发起者和目标之间的所有未来的 inter-PAN 通信都在逻辑信道字段中指示的信道上进行。在接收到设备信息请求 inter-PAN 命令帧时，目标应通过单播相应的设备信息响应 inter-PAN 命令帧来对其进行响应。

## **2.2 标识**

设备发现操作可以得到潜在的设备列表，应用程序可以从中选择一个或多个设备以进行进一步处理。为了支持用户确认，发起者可以让所选择的设备标识他们自己。

在设备发现事务内，发起者会生成并传输一个标识请求 inter-PAN 命令帧到适当的已发现目标设备。标识请求帧必须包含在设备发现期间与扫描请求 inter-PAN 命令帧中使用的相同的 inter-PAN 事务标识符。如果发起者希望发送进一步的标识请求帧，则它必须在活动事务时间内发送。否则，必须重复设备发现。

在接收到带有有效事务标识符的标识请求 inter-PAN 命令帧时，目标会根据标识时间字段的值以应用程序特定的方式（例如，通过闪烁灯）标识自身一段时间。如果此字段的值为 0x0000，则设备立即停止其标识操作。如果此字段的值为 0xffff，则设备会在应用程序特定的时间内标识自身。对于所有其他值，设备将标识自身等于此值（以秒为单位）的时间。如果接收到带有无效事务标识符的标识请求帧，则忽略此帧。不对标识请求帧生成响应。识别请求是非阻塞的。

## **2.3 形成和加入场景**

如 2.2 节所述，在这个点上，发起者可以形成一个新网络并将被标识的目标带入网络。如果发起者已经形成网络，则它可以将路由器或终端设备加入到其网络。网络开始请求帧和 网络加入路由器/网络加入终端设备 帧之间的主要区别在于后一帧中没有发起者的 IEEE 地址和发起者网络地址字段。此外，网络参数应该已经存在，并且应该包含在加入帧中。最后，对于后面的加入场景，在发起者端不需要网络重新加入请求。

------------------------------------------------------------------------------------------------------------------------

# **3. ZLL 和 Non-ZLL 设备**

除了触摸链接试运行之外，ZLL 设备（在应用程序控制下）支持经典的 ZigBee 试运行。由于经典的 ZigBee 试运行机制不支持地址范围的概念，即使设备具有地址分配能力，它也只会被分配一个地址。只有在终端设备与另一个 ZLL 设备进行触摸链接时，才能分配网络和分组地址范围。应用程序可以请求主要的网络发现，其中设备将在主要的 ZLL 信道集上进行。如果找到任何合适的网络，终端设备将尝试通过经典的 ZigBee 加入机制加入网络。如果加入成功，设备将被认证并等待从其父设备中接收网络密钥。收到网络密钥后，ZLL 地址和分组属性设置为 0x0000。如果未找到合适的网络或者加入不成功，则通过次要的 ZLL 信道集启动次要网络发现，并且如上所述继续加入和认证过程。如果在次要信道上找不到合适的网络，则加入失败，或者认证失败，ZLL 设备随机选择一个主要的 ZLL 信道并调谐到它。如果它是终端设备，则它进入低功率休眠状态并且不执行进一步处理。如果是路由器，则启用其接收器并等待触摸链接命令。

应用程序可以请求路由器在固定持续时间内启用其许可加入标志，以允许 Non-ZLL 设备在需要时使用标准 ZigBee 加入过程加入。如果设备尝试使用经典的 ZigBee 试运行加入，则路由器会使用经典的 ZigBee 机制分配地址。然后路由器将对设备进行认证：如果它位于受信任中心保护的网络上，则路由器将生成并（使用信任中心链路密钥担保）传输一个 APS 更新设备命令帧到信任中心，以允许其处理新设备。否则，路由器生成并（使用 ZLL 证明预安装链接密钥担保）传输一个 APS 传输密钥命令帧到加入设备。

对于受信任中心保护的网络，发起者可以在网络上与目标设备进行触摸链接，无论它是否在同一受信任中心保护的网络上；然而，在受信任中心保护的网络上的发起者和 新出厂/连接到不同网络 的目标设备之间不能执行触摸链接。

## **3.1 簇**

The ZLL profile ID is 0xc05e. However, for the purposes of interoperability, ZCL commands addressing clusters other than ZLL commissioning or those commands in the commissioning utility command set of the ZLL commissioning cluster, use the ZHA profile identifier, 0x0104. The ZLL commissioning cluster has a cluster ID of 0x1000.

## **3.2 设备 ID**

下面列出了 ZLL 规范中列出的设备描述和标识符，以及它们各自的 ZLL 试运行簇方向。ZLL 照明设备不需要支持 ZLL 试运行簇的试运行实用程序功能。

| 设备 | 设备描述 | 设备 ID | 试运行服务端 | 试运行 服务/客户 端 | 试运行客户端 |
| :--:| :-- | :-- | :--: | :--: | :--: |
| 照明设备 | On/off light | 0x0000 | [] | [] | [] |
| 照明设备 | On/off plug-in unit | 0x0010 | [] | [] | [] |
| 照明设备 | Dimmable light | 0x0100 | [] | [] | [] |
| 照明设备 | Dimmable plug-in unit | 0x0110 | [] | [] | [] |
| 照明设备 | Color light | 0x0200 | [] | [] | [] |
| 照明设备 | Extended color light | 0x0210 | [] | [] | [] |
| 照明设备 | Color temperature light | 0x0220 | [] | [] | [] |
| 控制器设备 | Color controller | 0x0800 | [] | [] | [] |
| 控制器设备 | Color scene controller | 0x0810 | [] | [] | [] |
| 控制器设备 | Non-color controller | 0x0820 | [] | [] | [] |
| 控制器设备 | Non-color scene controller | 0x0830 | [] | [] | [] |
| 控制器设备 | Control bridge | 0x0840 | [] | [] | [] |
| 控制器设备 | On/off sensor | 0x0850 | [] | [] | [] |

------------------------------------------------------------------------------------------------------------------------
